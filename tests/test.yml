# vim:ft=ansible:

- name: Bring up docker containers
  hosts: localhost
  tasks:
  - name: create a loop device
    shell: mknod -m 0660 /dev/sdz b 7 32
    become: true
  roles:
    - role: provision_docker
      provision_docker_inventory_group: "{{ groups['test-images'] }}"

- hosts: test-images
  vars:
    lvm_physical_device: /dev/sdz
  tasks:
  - name: install required packages
    yum:
      name: "{{ item }}"
      state: present
    with_items:
      - parted
  - name: create a disk image
    command: dd if=/dev/zero of=/tmp/pv bs=1 count=0 seek=2G
  - name: create a loop device
    shell: mknod -m 0660 /dev/sdz b 7 32
  - name: loopback attach
    command: losetup /dev/sdz /tmp/pv
  - name: check that /dev/sdz is a block device
    stat:
      path: /dev/sdz
      get_md5: false
      get_checksum: false
    register: lvm_physical_device_stats
  - name: fail if /dev/sdz is not a block device
    fail:
      msg: "/dev/sdz is not a block device"
    when:
      lvm_physical_device_stats.stat.isblk is defined and lvm_physical_device_stats.stat.isblk == False
  - name: create disk label
    command: /sbin/parted /dev/sdz mklabel gpt
  - shell: ls -al /dev/sdz
    register: result
  - debug:
      var: result

- hosts: test-images
  vars:
    lvm_physical_device: /dev/sdz
    docker_role_debug: true
  roles:
  - role: epiloque.docker
